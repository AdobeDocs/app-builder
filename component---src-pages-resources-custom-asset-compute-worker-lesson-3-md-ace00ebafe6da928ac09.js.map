{"version":3,"file":"component---src-pages-resources-custom-asset-compute-worker-lesson-3-md-ace00ebafe6da928ac09.js","mappings":"kTAMaA,EAAe,CAAC,EACvBC,EAAc,CAClBD,gBAEIE,EAAYC,EAAAA,EACH,SAASC,EAAUC,GAG/B,IAHgC,WACjCC,GAEDD,EADIE,GAAKC,EAAAA,EAAAA,GAAAH,EAAAI,GAER,OAAOC,EAAAA,EAAAA,KAACR,GAASS,EAAAA,EAAAA,GAAA,GAAKV,EAAiBM,EAAK,CAAED,WAAYA,EAAYM,QAAQ,eAG5EF,EAAAA,EAAAA,KAAA,MACE,GAAM,iCACJ,mCACJA,EAAAA,EAAAA,KAAA,SAAI,2CACJA,EAAAA,EAAAA,KAAA,YAAKA,EAAAA,EAAAA,KAAA,QAAMG,WAAW,MAClB,UAAa,iBACX,wCAENH,EAAAA,EAAAA,KAAA,SAAI,mEACJA,EAAAA,EAAAA,KAAA,WACEA,EAAAA,EAAAA,KAAA,MAAIG,WAAW,MAAM,gNACrBH,EAAAA,EAAAA,KAAA,MAAIG,WAAW,MAAM,yDAAwDH,EAAAA,EAAAA,KAAA,UAAQG,WAAW,MAAM,kCAA2C,MACjJH,EAAAA,EAAAA,KAAA,MAAIG,WAAW,MAAM,wCAAuCH,EAAAA,EAAAA,KAAA,UAAQG,WAAW,MAAM,8BAAuC,MAC5HH,EAAAA,EAAAA,KAAA,MAAIG,WAAW,MAAM,8EAA6EH,EAAAA,EAAAA,KAAA,cAAYG,WAAW,MAAM,OAAoB,iDAErJH,EAAAA,EAAAA,KAAA,SAAI,yBAAwBA,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,QAAqB,sMAE7EH,EAAAA,EAAAA,KAAA,YAAKA,EAAAA,EAAAA,KAAA,QAAMG,WAAW,MAClB,UAAa,iBACX,usBAkBNH,EAAAA,EAAAA,KAAA,SAAI,SAAQA,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,mBAAgC,qBAAoBH,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,kCAA+C,oBAAmBH,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,UAAuB,wFAC3OH,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,SAAsB,wIAC5BH,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,SAAsB,aAC1EH,EAAAA,EAAAA,KAAA,YAAKA,EAAAA,EAAAA,KAAA,QAAMG,WAAW,MAClB,UAAa,iBACX,42BA6BNH,EAAAA,EAAAA,KAAA,SAAI,kLAEJA,EAAAA,EAAAA,KAAA,YAAKA,EAAAA,EAAAA,KAAA,QAAMG,WAAW,MAClB,UAAa,iBACX,yDAENH,EAAAA,EAAAA,KAAA,SAAI,wDAAuDA,EAAAA,EAAAA,KAAA,cAAYG,WAAW,KAAK,gEAA6E,+CAEpKH,EAAAA,EAAAA,KAAA,YAAKA,EAAAA,EAAAA,KAAA,QAAMG,WAAW,MAClB,UAAa,uBACX,83DAyCV,CAEAT,EAAWU,gBAAiB,C","sources":["webpack://adobe-developer-app-builder/./src/pages/resources/custom-asset-compute-worker/lesson3.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n/* @jsx mdx */\nimport DefaultLayout from \"/home/runner/work/app-builder/app-builder/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"lesson-3-implement-the-worker\"\n    }}>{`Lesson 3: Implement the worker`}</h1>\n    <p>{`Create a new application using AIO CLI`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`$> aio app init my-custom-worker\n`}</code></pre>\n    <p>{`Application initialization will ask you a couple of questions:`}</p>\n    <ol>\n      <li parentName=\"ol\">{`To select your Adobe Organization, followed by the console project selection (pick the one you created in previous steps) and finally choose a project workspace where you added all the required services.`}</li>\n      <li parentName=\"ol\">{`Then, to pick the components of the app. Select only `}<strong parentName=\"li\">{`Actions: Deploy Runtime action`}</strong>{`.`}</li>\n      <li parentName=\"ol\">{`On the type of action, choose only: `}<strong parentName=\"li\">{`Adobe Asset Compute worker`}</strong>{`.`}</li>\n      <li parentName=\"ol\">{`At last step, you need to provide the name of the worker and wait for the `}<inlineCode parentName=\"li\">{`npm`}</inlineCode>{` to finish installing all the dependencies.`}</li>\n    </ol>\n    <p>{`Once it's done, edit `}<inlineCode parentName=\"p\">{`.env`}</inlineCode>{` file and add the following lines. These are the environment variables the AIO CLI uses. In a\nproduction deployment, you can set them directly on your CI/CD pipelines as environment variables.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`## A path to the private.key you obtained from Adobe Console\nASSET_COMPUTE_PRIVATE_KEY_FILE_PATH=/path/to/the/private.key\n\n## Azure blob storage container you created to simulate AEM binaries cloud storage\nAZURE_STORAGE_ACCOUNT=your-storage-account\nAZURE_STORAGE_KEY=your-storage-key\nAZURE_STORAGE_CONTAINER_NAME=source\n\n# Azure blob storage container used by the imgIX as assets source\nIMGIX_STORAGE_ACCOUNT=your-storage-account\nIMGIX_STORAGE_KEY=your-storage-key\nIMGIX_STORAGE_CONTAINER_NAME=imgix\n\n# A security token you obtained when setting up imgIX source\nIMGIX_SECURE_TOKEN=imgx-token\n# A imgix domain you defined when setting up imgIX source\nIMGIX_DOMAIN=your-subdomain.imgix.net\n`}</code></pre>\n    <p>{`Edit `}<inlineCode parentName=\"p\">{`ext.config.yaml`}</inlineCode>{` file inside the `}<inlineCode parentName=\"p\">{`src/dx-asset-compute-worker-1/`}</inlineCode>{` folder and add `}<inlineCode parentName=\"p\">{`inputs`}</inlineCode>{` object, as shown below. This file describes IO Runtime action to be deployed.\nAnd `}<inlineCode parentName=\"p\">{`input`}</inlineCode>{` param sets the default parameters with values referenced to our environment variables. Those params are\navailable in action JS as `}<inlineCode parentName=\"p\">{`param`}</inlineCode>{` object.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\"\n      }}>{`operations:\n  workerProcess:\n    - type: action\n      impl: dx-asset-compute-worker-1/worker\nhooks:\n  post-app-run: adobe-asset-compute devtool\n  test: adobe-asset-compute test-worker\nactions: actions\nruntimeManifest:\n  packages:\n    dx-asset-compute-worker-1:\n      license: Apache-2.0\n      actions:\n        czeczek-worker:\n          function: actions/worker/index.js\n          web: 'yes'\n          runtime: 'nodejs:14'\n          limits:\n            concurrency: 10\n          inputs:\n              imgixStorageAccount: $IMGIX_STORAGE_ACCOUNT\n              imgixStorageKey: $IMGIX_STORAGE_KEY\n              imgixStorageContainerName: $IMGIX_STORAGE_CONTAINER_NAME\n              imgixSecureToken: $IMGIX_SECURE_TOKEN\n              imgixDomain: $IMGIX_DOMAIN\n          annotations:\n            require-adobe-auth: true\n            final: true\n`}</code></pre>\n    <p>{`We also need to add two dependencies to our project. These are the libraries we will use to simplify access to the Azure\nblob storage and to generated signed URL for imgIX.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`$> npm install @adobe/aio-lib-files imgix-core-js\n`}</code></pre>\n    <p>{`Finally, edit the worker source code (located under `}<inlineCode parentName=\"p\">{`src/dx-asset-compute-worker-1/actions/<worker-name>/index.js`}</inlineCode>{`) and replace it\nwith the following code.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`'use strict';\n\nconst { worker } = require('@adobe/asset-compute-sdk');\n//Convinient library provided by adobe that abstract away managing files on cloud storages\nconst filesLib = require('@adobe/aio-lib-files');\nconst { downloadFile } = require('@adobe/httptransfer');\nconst ImgixClient = require('imgix-core-js');\n\nexports.main = worker(async (source, rendition, params) => {\n  //Initialize blob storage client used by imgix\n  //We're reading the parameters we defined in manifest.yml\n  const targetStorage = await filesLib.init({\n    azure: {\n      storageAccount: params.imgixStorageAccount,\n      storageAccessKey: params.imgixStorageKey,\n      containerName: params.imgixStorageContainerName,\n    },\n  });\n  //Copy source asset from the AEM binaries storage to the Azure blob storage for imgIX\n  // localSrc:true means, the first parameters points to the file in the local file system (asset-compute-sdk abstracts the source blob storage so it's visible as local file)\n  // Second arguments defines the path on the target blob storage. We use the same path just to simplify things\n  await targetStorage.copy(source.path, source.path, { localSrc: true });\n\n  //Initialize imgix client responsible for generation of signed URLs\n  //to our assets accessed via imgIX subdomain\n  //We're getting the config params we defined in manifest.yml\n  const client = new ImgixClient({\n    domain: params.imgixDomain,\n    secureURLToken: params.imgixSecureToken,\n  });\n\n  //Generate signed URL with the params send by AEM and sign it.\n  //All the parameters send by AEM are available under rendition.instructions object\n  const url = client.buildURL(source.path, JSON.parse(rendition.instructions.imgix));\n\n  //Finally, download a rendition from a given url and store in AEM azure blob storage so it will be visible in AEM as a rendition\n  await downloadFile(url, rendition.path);\n});\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","_ref","components","props","_objectWithoutProperties","_excluded","mdx","_extends","mdxType","parentName","isMDXComponent"],"sourceRoot":""}