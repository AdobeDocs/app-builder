"use strict";(self.webpackChunkadobe_developer_app_builder=self.webpackChunkadobe_developer_app_builder||[]).push([[110],{15857:function(e,n,t){t.r(n),t.d(n,{_frontmatter:function(){return l},default:function(){return d}});var a=t(58168),o=t(80045),s=(t(88763),t(15680)),i=t(83407);const r=["components"],l={},u={_frontmatter:l},m=i.A;function d(e){let{components:n}=e,t=(0,o.A)(e,r);return(0,s.mdx)(m,(0,a.A)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,s.mdx)("h1",{id:"lesson-2-create-an-event-consumer-using-the-journaling-api"},"Lesson 2: Create an Event Consumer using the Journaling API"),(0,s.mdx)("p",null,"In this lesson, we will:"),(0,s.mdx)("ul",null,(0,s.mdx)("li",{parentName:"ul"},"Create an event consumer using an App Builder template"),(0,s.mdx)("li",{parentName:"ul"},"Use ",(0,s.mdx)("a",{parentName:"li",href:"https://github.com/adobe/aio-lib-state"},"aio-lib-state")," as the storage library for events from the Journaling api"),(0,s.mdx)("li",{parentName:"ul"},"Schedule cron jobs with alarms to trigger the event consumer to pull events from the Journaling API every x minutes")),(0,s.mdx)("h2",{id:"create-an-event-consumer-using-an-app-builder-template"},"Create an event consumer using an App Builder template"),(0,s.mdx)("p",null,"We will use an App Builder template to create the event consumer, this time using the ",(0,s.mdx)("inlineCode",{parentName:"p"},"generic")," template. In this Code Lab we will create a headless app following ",(0,s.mdx)("a",{parentName:"p",href:"../cron-jobs/index.md"},"this procedure"),"."),(0,s.mdx)("p",null,"The Adobe I/O Events Journaling API supports enterprise integrations that consume events at their own cadence and process them in bulk. Unlike webhooks, no additional registration or other configuration is required; every enterprise integration that is registered for events is automatically enabled for journaling. Journaling data is retained for 7 days."),(0,s.mdx)("p",null,"After you fire an event, you should be able to verify your event through journaling the unique API endpoint you get from the console following the instructions below. You could use the curl command or Postman to call this journaling unique API endpoint to see your fired event. Or you could use ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-events"},"Custom Event SDK")," to call the Journaling API to retrieve your event."),(0,s.mdx)("h2",{id:"write-the-data-into-app-builder-storage"},"Write the data into App Builder storage"),(0,s.mdx)("p",null,"We will use ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-state"},"aio-lib-state")," to store the event from the Journaling API. First, we install the dependency:"),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-bash"},"npm i --save @adobe/aio-lib-state\n")),(0,s.mdx)("p",null,"Then we import it:"),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-javascript"},"const stateLib = require('@adobe/aio-lib-state');\n")),(0,s.mdx)("p",null,"Set up write to storage inside the main function: "),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-javascript"},"async function saveToDb(params, new_events) {\n  const stateCLient = await State.init()\n\n\n  var events = await stateCLient.get(params.db_event_key) \n  if (events === undefined) {\n    events = {latest: new_events[new_events.length - 1], events: new_events}\n  } else {\n    events = events.value\n    events.latest = new_events[new_events.length - 1]\n    events.events.push(new_events)\n  }\n  await stateCLient.put(params.db_event_key, events, { ttl: -1 })\n}\n")),(0,s.mdx)("p",null,"Write down the event postion to make sure that if the action fails the next invocation will retrieve from the same index instead of the new one. This way, no events are lost."),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-javascript"},"async function getLatestEventPosition(params) {\n  const stateCLient = await State.init()\n  const events = await stateCLient.get(params.db_event_key)\n  if (events === undefined) {\n    return undefined\n  } else {\n    return events.value.latest.position\n  }\n}\n")),(0,s.mdx)("p",null,"You can see the source code ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/AdobeDocs/adobeio-samples-journaling-events/blob/main/event-consumer/actions/event_consumer/index.js"},"here"),"."),(0,s.mdx)("h2",{id:"scheduling-cron-jobs-to-automate-consuming-events"},"Scheduling cron jobs to automate consuming events"),(0,s.mdx)("p",null,"Following the same steps as in ",(0,s.mdx)("a",{parentName:"p",href:"../cron-jobs/lesson2.md"},"lesson 2 of Scheduling Cron Jobs with Alarms"),", schedule cron jobs to make sure the consumer is pulling events from journaling API every x minutes. Now we can deploy this event consumer app in another runtime namespace. "))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-resources-journaling-events-lesson-2-md-c2fe675e39cb33ac8519.js.map