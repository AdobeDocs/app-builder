"use strict";(self.webpackChunkadobe_developer_app_builder=self.webpackChunkadobe_developer_app_builder||[]).push([[9565],{65551:function(e,n,a){a.r(n),a.d(n,{_frontmatter:function(){return d},default:function(){return p}});var t=a(58168),o=a(80045),i=(a(88763),a(15680)),r=a(83407);const l=["components"],d={},s={_frontmatter:d},m=r.A;function p(e){let{components:n}=e,a=(0,o.A)(e,l);return(0,i.mdx)(m,(0,t.A)({},s,a,{components:n,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"creating-actions"},"Creating Actions"),(0,i.mdx)("p",null,"To execute as an action on Adobe I/O Runtime, the function you code must both :"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"Either be named ",(0,i.mdx)("em",{parentName:"li"},"main")," or have an entry point exported as ",(0,i.mdx)("em",{parentName:"li"},"main")," - the function that will be executed when invoked"),(0,i.mdx)("li",{parentName:"ul"},"Accept valid JSON objects as input, and output valid JSON objects")),(0,i.mdx)("p",null,"To create and invoke actions, you must also configure the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," CLI on your machine: refer to the ",(0,i.mdx)("a",{parentName:"p",href:"tools/cli_install.md"},"aio CLI")," page for installation and configuration instructions. "),(0,i.mdx)("p",null,"Let's assume you have this function available on your machine:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},"// this is saved in a file named first-function.js\nfunction main(params) {\n    var nm = params.name || 'stranger';\n    return {payload: 'Hello ' + nm};\n}\n\nexports.main = main;\n")),(0,i.mdx)("p",null,"You can now create an action called ",(0,i.mdx)("inlineCode",{parentName:"p"},"test")," using this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:create test first-function.js\n")),(0,i.mdx)("p",null,"You may update it at any time using this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:update test first-function.js\n")),(0,i.mdx)("p",null,"When you no longer need an action, you can delete it:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:delete test\n")),(0,i.mdx)("p",null,"To save an action deployed to your machine, use this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:get test --save \n")),(0,i.mdx)("p",null,"To list all the actions available in your current namespace, run this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:list\n")),(0,i.mdx)("h2",{id:"invoking-actions"},"Invoking actions"),(0,i.mdx)("p",null,"Once you have an action, for example ",(0,i.mdx)("inlineCode",{parentName:"p"},"test"),", call it using this command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test --result\n")),(0,i.mdx)("p",null,"Note the ",(0,i.mdx)("inlineCode",{parentName:"p"},"--result")," flag; it outputs the result of the invocation. Without it, the invocation would return the activation ID instead of a result. In that case, you could use the activation ID to retrieve the result:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:activation:get <activation ID>\n")),(0,i.mdx)("p",null,"When you invoke an action this way, the invocation is not blocking - in other words, it is asynchronous. To execute it in a blocking style and therefore get an activation record instead of just an ID,  add the ",(0,i.mdx)("inlineCode",{parentName:"p"},"--blocking")," flag to the command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test --blocking\n")),(0,i.mdx)("h2",{id:"working-with-parameters"},"Working with parameters"),(0,i.mdx)("p",null,"Actions can receive parameters while they are being executed. Parameters sent to an action are available using the ",(0,i.mdx)("inlineCode",{parentName:"p"},"params")," variable. Parameters called ",(0,i.mdx)("em",{parentName:"p"},"first-name")," and ",(0,i.mdx)("em",{parentName:"p"},"last-name"),"  will be available as ",(0,i.mdx)("em",{parentName:"p"},"params.first-name")," and ",(0,i.mdx)("em",{parentName:"p"},"params.last-name"),"."),(0,i.mdx)("p",null,"To invoke an action with parameters, set a parameter like ",(0,i.mdx)("inlineCode",{parentName:"p"},"name")," in our function sample above, in this way:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'aio rt:action:invoke test --param name "John Doe" --result\n')),(0,i.mdx)("h2",{id:"setting-default-parameters"},"Setting default parameters"),(0,i.mdx)("p",null,"To bind the same parameter values for all invocations or set default values, you have two options: set them at the package level so all actions in the package inherit them, or set them at the action level."),(0,i.mdx)("h3",{id:"default-params-and-encryption"},"Default params and encryption"),(0,i.mdx)("p",null,"Developers often use the default parameters as a way to provision actions with the secrets and passwords they need to authenticate against databases, services, APIs, or other systems."),(0,i.mdx)("p",null,"To support this use case, default parameters are automatically encrypted, and decrypted just before the action code is executed. The decrypted value is therefore accessible only while the action code executes."),(0,i.mdx)("p",null,"The CLI command to get an action or package will return a listing of the default parameter names; the values will be listed as a hashes of the actual values."),(0,i.mdx)("h3",{id:"set-default-parameters-on-action"},"Set default parameters on action"),(0,i.mdx)("p",null,'Assume you want the default value of your parameter to be "Runtime". You can set it when creating the action or updating an existing action. In either case, add the ',(0,i.mdx)("inlineCode",{parentName:"p"},"--param")," flag:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'// creation time\naio rt:action:create test first-function.js --param name "Runtime"\n\n// update\naio rt:action:update test first-function.js --param name "Runtime"\n')),(0,i.mdx)("p",null,"When you run this action without any parameters,  it will use the default values. Parameter set during invocation will overwrite the defaults."),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Note: When updating an action's params using ",(0,i.mdx)("inlineCode",{parentName:"p"},"--param <key> <value>")," as above, you must specify all of the parameters, because all previous values will be overwritten.")),(0,i.mdx)("h3",{id:"set-default-parameters-on-package"},"Set default parameters on package"),(0,i.mdx)("p",null,"Actions are always created in a package. If you don't specify a package, the default package is used. In the same way you set default parameters at the action level, you can specify them at the package level. Parameters set at the package level will be used for all  actions created in that package."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'// creation time\naio rt:package:create my-package --param name "Runtime"\n\n// update\naio rt:package:update my-package --param name "Runtime"\n')),(0,i.mdx)("p",null,"In case of conflict, the precedence rules are: parameters set at invocation time override those set at the action level, which in turn override those set at the package level."),(0,i.mdx)("h3",{id:"use-parameter-files-to-set-default-parameters"},"Use parameter files to set default parameters"),(0,i.mdx)("p",null,"You can use a dedicated file to store default parameter values, and then use the file to set them. This is useful when you need to set multiple parameter values while configuring API access keys, endpoints, and so on."),(0,i.mdx)("p",null,"Returning to the sample function that expects the single parameter, ",(0,i.mdx)("inlineCode",{parentName:"p"},"name"),", you would create a JSON file to store its value:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'// filename is my-params.json\n{\n    "name": "Runtime"\n}\n')),(0,i.mdx)("p",null,"Then use the ",(0,i.mdx)("inlineCode",{parentName:"p"},"--param-file")," flag when creating actions, creating packages, or invoking actions:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"// update action\naio rt:action:update test first-function.js --param-file my-params.json\n\n// invoke action\naio rt:action:invoke test --param-file my-params.json\n")),(0,i.mdx)("h3",{id:"final-parameters"},"Final parameters"),(0,i.mdx)("p",null,"Sometimes, applications need to make sure their default parameters are final, or immutable, so calling clients can't override them. Achieve this by adding the ",(0,i.mdx)("inlineCode",{parentName:"p"},"final")," annotation - ",(0,i.mdx)("inlineCode",{parentName:"p"},"-a final true"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'aio rt:action:update test first-function.js --web true --param name "Runtime" -a final true\n')),(0,i.mdx)("p",null,"This mechanism works for all actions, including web actions."),(0,i.mdx)("h2",{id:"invoking-web-actions"},"Invoking web actions"),(0,i.mdx)("p",null,"The actions shown above were invoked from the CLI. This is fine for development and test, but production systems might need to invoke actions from HTTP REST calls, for example from a web application. "),(0,i.mdx)("p",null,"Create web actions by adding the ",(0,i.mdx)("em",{parentName:"p"},"--web")," flag to the ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," action command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"// creation time\naio rt:action:create test first-function.js --web true\n\n// update\naio rt:action:update test first-function.js --web true\n")),(0,i.mdx)("p",null,"Note the ",(0,i.mdx)("inlineCode",{parentName:"p"},"true")," value used in the command: setting it to ",(0,i.mdx)("inlineCode",{parentName:"p"},"false"),"  would disable the web action."),(0,i.mdx)("p",null,"To call a web action, specify the full path to the action, which you can find by adding the ",(0,i.mdx)("inlineCode",{parentName:"p"},"--url")," flag to the action command:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:get test --url\n")),(0,i.mdx)("p",null,"This will return something like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"ok: got action test\nhttps://adobeioruntime.net/api/v1/web/[your namespace]/default/test\n")),(0,i.mdx)("p",null,"In the URL above, ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," stands for the ",(0,i.mdx)("inlineCode",{parentName:"p"},"default")," package that contains actions when you don't create them explicitly in a named package."),(0,i.mdx)("p",null,"You can invoke the web action like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl -L https://adobeioruntime.net/api/v1/web/[your namespace]/default/test -X GET\n")),(0,i.mdx)("p",null,"or like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"curl https://[your namespace].adobeioruntime.net/api/v1/web/default/test -X GET\n")),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Note the difference between this URL and the one ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," returns. This is because when invoking web actions, Runtime adds protections that segregate namespaces from each other . The ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio"),"-generated link will still work, but it will return a 308 redirect to your namespace's subdomain on Runtime. For a further discussion of this please see ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions"),".")),(0,i.mdx)("h3",{id:"successful-response"},"Successful response"),(0,i.mdx)("p",null,"To send a response that follows the status code-headers-body HTTP response structure from an action to be used as a web action, you could rewrite our sample function:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},"function main(params) {\n    var nm = params.name || 'stranger';\n    return {\n        statusCode: 200,\n        body: {\n            payload: 'Hello ' + nm\n        }\n    }\n}\n\nexports.main = main;\n")),(0,i.mdx)("p",null,"This approach also allows you to set cookies or cache control headers, perform HTTP redirects, and so on."),(0,i.mdx)("h3",{id:"unsuccessful-response"},"Unsuccessful response"),(0,i.mdx)("p",null,"On failed action invocations, the error code and message should be wrapped in an ",(0,i.mdx)("inlineCode",{parentName:"p"},"error")," object: this allows the system to interpret the response as an ",(0,i.mdx)("inlineCode",{parentName:"p"},"applicationError"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'async function main(params) {\n    try {\n        throw new Error("Boom!")\n    } catch (err) {\n        return {\n            error: {\n                statusCode: 500,\n                body: {\n                    payload: `Something went wrong: ${err}`\n                }\n            }\n        }\n    }\n}\n\nexports.main = main;\n')),(0,i.mdx)("h3",{id:"general-error-handling"},"General error handling"),(0,i.mdx)("p",null,"Handling errors in action code is extremely important: it is literally impossible to recover from a unhandled asynchronous errors in Node.js. Please refer to the ",(0,i.mdx)("a",{parentName:"p",href:"https://nodejs.org/api/process.html#event-uncaughtexception"},"uncaughtExceptions")," discussion in Node.js documentation."),(0,i.mdx)("p",null,"An unhandled asynchronous errors will cause termination of the action and destruction of the container running it. As a result, all in-flight activations will be failed, and the next action invocation will incur the overhead of creating a new container."),(0,i.mdx)("p",null,"Here are incorrect and correct methods to handle asynchronous errors:"),(0,i.mdx)("h4",{id:"incorrect-handling-of-async-errors"},"Incorrect handling of async errors"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'function doSomethingAsync() {\n    return new Promise((resolve, reject) => {\n        try {\n            setTimeout(() => {\n                new Error("Something went wrong");\n            }, 1000);\n        } catch (err) {\n            reject(err);\n        }\n    });\n}\n')),(0,i.mdx)("p",null,"Here, the error is generated not while the executor is running, but afterwards. As a result, the try catch block will not catch the error, and the action will be terminated."),(0,i.mdx)("h4",{id:"correct-handling-of-async-errors"},"Correct handling of async errors"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},'function doSomethingAsync() {\n    return new Promise((resolve, reject) => {\n        setTimeout(() => {\n            reject(new Error("Something went wrong"));\n        }, 1000);\n    });\n}\n')),(0,i.mdx)("p",null,"This code will execute correctly and the error will be handled.     "),(0,i.mdx)("p",null,"When asynchronous operations are performed, there is almost always a chance for something to go wrong: network errors, a database connection issues, unexpected inputs, and more.\nTo ensure the reliability and stability of the program, errors should always be handled inside the callback function passed to setTimeout or any other asynchronous function."),(0,i.mdx)("h3",{id:"http-context"},"HTTP context"),(0,i.mdx)("p",null,"When executing actions as web actions, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"params")," object is decorated with additional information:"),(0,i.mdx)("table",null,(0,i.mdx)("thead",{parentName:"table"},(0,i.mdx)("tr",{parentName:"thead"},(0,i.mdx)("th",{parentName:"tr",align:null},"Method"),(0,i.mdx)("th",{parentName:"tr",align:null},"Description"))),(0,i.mdx)("tbody",{parentName:"table"},(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_method")),(0,i.mdx)("td",{parentName:"tr",align:null},"the HTTP method of the request")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_headers")),(0,i.mdx)("td",{parentName:"tr",align:null},"the request headers")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_path")),(0,i.mdx)("td",{parentName:"tr",align:null},"the unmatched path of the request (matching stops after consuming the action extension)")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_body")),(0,i.mdx)("td",{parentName:"tr",align:null},"the request body entity, as a base64-encoded string when its content is binary or JSON object/array, or as a plain string otherwise")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"__ow_query")),(0,i.mdx)("td",{parentName:"tr",align:null},"the query parameters from the request as an unparsed string")))),(0,i.mdx)("p",null,"By default, web actions are accessible to anyone who knows their URLs. To secure access, review ",(0,i.mdx)("a",{parentName:"p",href:"securing_web_actions.md"},"Securing Web Actions"),"."),(0,i.mdx)("h2",{id:"deploying-zip-actions"},"Deploying ZIP actions"),(0,i.mdx)("p",null,"The actions above were created from single source files. To create actions from multiple files or add npm modules, deploy ZIP actions. "),(0,i.mdx)("p",null,"Requirements to deploy a ZIP action are:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("p",{parentName:"li"},"Configure ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," instead of ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio")," ")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("p",{parentName:"li"},"Create the package.json file")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("p",{parentName:"li"},"Create a manifest file"))),(0,i.mdx)("h3",{id:"wskdeploy"},"wskdeploy"),(0,i.mdx)("p",null,"If you need to install ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy"),", check ",(0,i.mdx)("a",{parentName:"p",href:"tools/wskdeploy_install.md"},"Setting up the wskdeploy CLI"),"."),(0,i.mdx)("h3",{id:"packagejson-file"},"Package.json file"),(0,i.mdx)("p",null,"You use the package.json file to specify the dependencies. If you don't have one already, in the same folder where your function files are, run ",(0,i.mdx)("inlineCode",{parentName:"p"},"npm init -y"),"."),(0,i.mdx)("p",null,"Make sure to declare any npm dependencies required for your functions in the package file."),(0,i.mdx)("h3",{id:"wskdeploy-manifest-file"},"wskdeploy manifest file"),(0,i.mdx)("p",null,"The final step in deploying a ZIP action is to create the manifest file wskdeploy will use to create the action. In the parent folder of the folder that contains your function files and npm modules, create a ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml"),"file. See the ",(0,i.mdx)("a",{parentName:"p",href:"http://yaml.org/refcard.html"},"YAML reference card")," for more information on YAML format."),(0,i.mdx)("p",null,"This is the folder structure:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"--/actions\n--/actions/node_modules/\n--/actions/index.js\n--/actions/package.json\n--manifest.yaml\n")),(0,i.mdx)("p",null,"Here is a sample ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"packages:\n    # this is the package name\n    test:\n        actions:\n            # name of the action\n            test-zip:\n                # source for the action; in this case it is a folder\n                function: actions\n                runtime: nodejs:10\n                # publish the action as a web action\n                web:  yes\n")),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Note: If your action requires dependencies such as other node modules or JavaScript files, place the action code in an ",(0,i.mdx)("inlineCode",{parentName:"p"},"index.js")," file and in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml")," file. The ",(0,i.mdx)("inlineCode",{parentName:"p"},"function")," value should point to the folder where the action is stored instead of the action file. These conditions are met in the example above.")),(0,i.mdx)("p",null,"To deploy, run the ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," command from the folder that contains ",(0,i.mdx)("inlineCode",{parentName:"p"},"manifest.yaml"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"wskdeploy\n")),(0,i.mdx)("p",null,"This will deploy an action called ",(0,i.mdx)("inlineCode",{parentName:"p"},"test-zip")," under a package called ",(0,i.mdx)("inlineCode",{parentName:"p"},"test"),"; it can be invoked like this:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"aio rt:action:invoke test/test-zip --result\n")),(0,i.mdx)("p",null,"To emove the action, run ",(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," with the ",(0,i.mdx)("em",{parentName:"p"},"undeploy")," flag:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"wskdeploy undeploy\n")),(0,i.mdx)("p",null,(0,i.mdx)("inlineCode",{parentName:"p"},"wskdeploy")," supports other useful flows; please check the ",(0,i.mdx)("a",{parentName:"p",href:"https://github.com/apache/openwhisk-wskdeploy"},"official documentation")," to learn about them."),(0,i.mdx)("blockquote",null,(0,i.mdx)("p",{parentName:"blockquote"},"Note: You can also deploy ZIP actions using the aio command. This approach lacks the flexibility of the manifest.yaml file: it won't allow definition of multiple actions or packages at the same time. The ZIP file has to have in the root the package.json file.  ",(0,i.mdx)("inlineCode",{parentName:"p"},"aio rt:action:create my-action --kind nodejs:20 zip-file.zip"))),(0,i.mdx)("h2",{id:"next-step"},"Next step"),(0,i.mdx)("p",null,"Return to ",(0,i.mdx)("a",{parentName:"p",href:"../../guides/index.md"},"Guides Index"),"."))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-runtime-guides-creating-actions-md-b110363b996b155e0dd4.js.map