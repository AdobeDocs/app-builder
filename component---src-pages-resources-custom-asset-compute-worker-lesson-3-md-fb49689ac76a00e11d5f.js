"use strict";(self.webpackChunkadobe_developer_app_builder=self.webpackChunkadobe_developer_app_builder||[]).push([[6987],{32156:function(e,n,t){t.r(n),t.d(n,{_frontmatter:function(){return l},default:function(){return c}});var a=t(58168),o=t(80045),i=(t(88763),t(15680)),r=t(83407);const s=["components"],l={},m={_frontmatter:l},d=r.A;function c(e){let{components:n}=e,t=(0,o.A)(e,s);return(0,i.mdx)(d,(0,a.A)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"lesson-3-implement-the-worker"},"Lesson 3: Implement the Worker"),(0,i.mdx)("p",null,"Create a new application using the AIO CLI:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"$> aio app init my-custom-worker\n")),(0,i.mdx)("p",null,"In answer to the questions application initialization will ask you:"),(0,i.mdx)("ol",null,(0,i.mdx)("li",{parentName:"ol"},"Select your Adobe Organization, the console project selection you created in previous steps, and a project workspace where you added the required services."),(0,i.mdx)("li",{parentName:"ol"},"Pick the components of the app: select only ",(0,i.mdx)("strong",{parentName:"li"},"Actions: Deploy Runtime action"),"."),(0,i.mdx)("li",{parentName:"ol"},"On the type of action, choose only ",(0,i.mdx)("strong",{parentName:"li"},"Adobe Asset Compute worker"),"."),(0,i.mdx)("li",{parentName:"ol"},"Provide the name of the worker, and wait for the ",(0,i.mdx)("inlineCode",{parentName:"li"},"npm")," to finish installing all the dependencies.")),(0,i.mdx)("p",null,"Once it's done, edit the  ",(0,i.mdx)("inlineCode",{parentName:"p"},".env")," file and add the environment variables the AIO CLI uses. In a production deployment, you can set them directly on your CI/CD pipelines as environment variables:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"## A path to the private.key you obtained from Adobe Console\nASSET_COMPUTE_PRIVATE_KEY_FILE_PATH=/path/to/the/private.key\n\n## Azure blob storage container you created to simulate AEM binaries cloud storage\nAZURE_STORAGE_ACCOUNT=your-storage-account\nAZURE_STORAGE_KEY=your-storage-key\nAZURE_STORAGE_CONTAINER_NAME=source\n\n# Azure blob storage container used by the imgIX as assets source\nIMGIX_STORAGE_ACCOUNT=your-storage-account\nIMGIX_STORAGE_KEY=your-storage-key\nIMGIX_STORAGE_CONTAINER_NAME=imgix\n\n# A security token you obtained when setting up imgIX source\nIMGIX_SECURE_TOKEN=imgx-token\n# A imgix domain you defined when setting up imgIX source\nIMGIX_DOMAIN=your-subdomain.imgix.net\n")),(0,i.mdx)("p",null,"Edit the ",(0,i.mdx)("inlineCode",{parentName:"p"},"ext.config.yaml")," file inside the ",(0,i.mdx)("inlineCode",{parentName:"p"},"src/dx-asset-compute-worker-1/")," folder and add the ",(0,i.mdx)("inlineCode",{parentName:"p"},"inputs")," object as shown below. This file describes the I/O Runtime action to be deployed. An ",(0,i.mdx)("inlineCode",{parentName:"p"},"input")," parameter sets the default parameters with values referenced to our environment variables. Those parameters are available in action JS as ",(0,i.mdx)("inlineCode",{parentName:"p"},"param")," object."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-yaml"},"operations:\n  workerProcess:\n    - type: action\n      impl: dx-asset-compute-worker-1/worker\nhooks:\n  post-app-run: adobe-asset-compute devtool\n  test: adobe-asset-compute test-worker\nactions: actions\nruntimeManifest:\n  packages:\n    dx-asset-compute-worker-1:\n      license: Apache-2.0\n      actions:\n        czeczek-worker:\n          function: actions/worker/index.js\n          web: 'yes'\n          runtime: 'nodejs:14'\n          limits:\n            concurrency: 10\n          inputs:\n              imgixStorageAccount: $IMGIX_STORAGE_ACCOUNT\n              imgixStorageKey: $IMGIX_STORAGE_KEY\n              imgixStorageContainerName: $IMGIX_STORAGE_CONTAINER_NAME\n              imgixSecureToken: $IMGIX_SECURE_TOKEN\n              imgixDomain: $IMGIX_DOMAIN\n          annotations:\n            require-adobe-auth: true\n            final: true\n")),(0,i.mdx)("p",null,"We will also need to add two dependencies to our project. These are the libraries we will use to simplify access to the Azure\nblob storage and to generate signed URL for imgIX."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},"$> npm install @adobe/aio-lib-files imgix-core-js\n")),(0,i.mdx)("p",null,"Finally, edit the worker source code located under ",(0,i.mdx)("inlineCode",{parentName:"p"},"src/dx-asset-compute-worker-1/actions/<worker-name>/index.js"),", and replace it with:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-javascript"},"'use strict';\n\nconst { worker } = require('@adobe/asset-compute-sdk');\n//Convinient library provided by adobe that abstract away managing files on cloud storages\nconst filesLib = require('@adobe/aio-lib-files');\nconst { downloadFile } = require('@adobe/httptransfer');\nconst ImgixClient = require('imgix-core-js');\n\nexports.main = worker(async (source, rendition, params) => {\n  //Initialize blob storage client used by imgix\n  //We're reading the parameters we defined in manifest.yml\n  const targetStorage = await filesLib.init({\n    azure: {\n      storageAccount: params.imgixStorageAccount,\n      storageAccessKey: params.imgixStorageKey,\n      containerName: params.imgixStorageContainerName,\n    },\n  });\n  //Copy source asset from the AEM binaries storage to the Azure blob storage for imgIX\n  // localSrc:true means, the first parameters points to the file in the local file system (asset-compute-sdk abstracts the source blob storage so it's visible as local file)\n  // Second arguments defines the path on the target blob storage. We use the same path just to simplify things\n  await targetStorage.copy(source.path, source.path, { localSrc: true });\n\n  //Initialize imgix client responsible for generation of signed URLs\n  //to our assets accessed via imgIX subdomain\n  //We're getting the config params we defined in manifest.yml\n  const client = new ImgixClient({\n    domain: params.imgixDomain,\n    secureURLToken: params.imgixSecureToken,\n  });\n\n  //Generate signed URL with the params send by AEM and sign it.\n  //All the parameters send by AEM are available under rendition.instructions object\n  const url = client.buildURL(source.path, JSON.parse(rendition.instructions.imgix));\n\n  //Finally, download a rendition from a given url and store in AEM azure blob storage so it will be visible in AEM as a rendition\n  await downloadFile(url, rendition.path);\n});\n")))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-resources-custom-asset-compute-worker-lesson-3-md-fb49689ac76a00e11d5f.js.map