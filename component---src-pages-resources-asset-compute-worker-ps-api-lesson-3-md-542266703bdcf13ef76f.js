"use strict";(self.webpackChunkadobe_developer_app_builder=self.webpackChunkadobe_developer_app_builder||[]).push([[2522],{4759:function(e,o,n){n.r(o),n.d(o,{_frontmatter:function(){return p},default:function(){return u}});var t=n(58168),a=n(80045),s=(n(88763),n(15680)),i=n(83407);const r=["components"],p={},d={_frontmatter:p},l=i.A;function u(e){let{components:o}=e,n=(0,a.A)(e,r);return(0,s.mdx)(l,(0,t.A)({},d,n,{components:o,mdxType:"MDXLayout"}),(0,s.mdx)("h1",{id:"lesson-3-develop-custom-worker-calling-photoshop-apis"},"Lesson 3: Develop Custom Worker Calling Photoshop APIs"),(0,s.mdx)("p",null,"Now that you have the development environment set up locally and can run a basic worker, let's enhance it to do something more complex."),(0,s.mdx)("p",null,(0,s.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/photoshop/"},"Adobe Photoshop APIs")," let you to build plugins and integrations that harness the power of the worldâ€™s best image editing and graphic design software to transform creative workflows for users everywhere. In this Code Lab, you use the Photoshop APIs to generate custom renditions in AEM Assets."),(0,s.mdx)("p",null,"You will need the ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-files"},"App Builder Files SDK")," to store images, the ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-photoshop-api"},"Photoshop API SDK")," to call Photoshop APIs, and UUID to generate unique folder names for renditions of different images. Add them as dependencies in your ",(0,s.mdx)("inlineCode",{parentName:"p"},"package.json")," file."),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-json"},'"dependencies": {\n    "@adobe/aio-lib-photoshop-api": "0.0.4-beta.4",\n    "@adobe/aio-sdk": "^2.3.0",\n    "@adobe/asset-compute-sdk": "^2.2.1",\n    "uuid": "^8.0.0"\n}\n')),(0,s.mdx)("blockquote",null,(0,s.mdx)("p",{parentName:"blockquote"},"Note: At the time of writing, Photoshop API SDK is in beta release and its version is constantly changing. Please visit its ",(0,s.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-photoshop-api"},"GitHub repository")," to find out the latest version.")),(0,s.mdx)("p",null,"Make sure you run ",(0,s.mdx)("inlineCode",{parentName:"p"},"npm install")," after updating the ",(0,s.mdx)("inlineCode",{parentName:"p"},"package.json")," file, so that all the npm modules are installed."),(0,s.mdx)("p",null,"Then update your action code in ",(0,s.mdx)("inlineCode",{parentName:"p"},"actions/<worker-name>/index.js")," to use the Photoshop API SDK. In this example, it calls the ",(0,s.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/firefly-services/docs/photoshop/api/photoshop_removeBackground/"},"Remove Background API")," to remove the background of an image."),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-javascript"},"const { worker, SourceCorruptError } = require('@adobe/asset-compute-sdk');\nconst fs = require('fs').promises;\nconst { Files } = require('@adobe/aio-sdk');\nconst Photoshop = require('@adobe/aio-lib-photoshop-api');\nconst { v4: uuid4 } = require('uuid');\n\nexports.main = worker(async (source, rendition, params) => {\n    const files = await Files.init();\n\n    // obtain access token and org ID\n    const accessToken = params.auth && params.auth.accessToken;\n    const orgId = params.auth && params.auth.orgId;\n\n    // init Photoshop SDK client\n    const psClient = await Photoshop.init(orgId, params.apiKey, accessToken, files);\n\n    // create a new directory in aio-lib-files with unique name\n    const imageId = uuid4();\n    const aioSourcePath = `${imageId}/source.png`;\n    const aioRenditionPath = `${imageId}/rendition.png`;\n\n    await files.copy(source.path, aioSourcePath, { localSrc: true });\n\n    // call Photoshop API to do cutout processing, and poll status until it's successful\n    const result = await psClient.createCutout(aioSourcePath, aioRenditionPath);\n    await result.pollUntilDone(1000);\n\n    // download the rendition to local AEM Assets destination\n    await files.copy(aioRenditionPath, rendition.path, { localDest: true });\n\n    // clean up files processing folder in aio-lib-files\n    await files.delete(`${imageId}/`);\n});\n")),(0,s.mdx)("p",null,"Because the SDK requires ",(0,s.mdx)("inlineCode",{parentName:"p"},"apiKey")," to be passed in the input params, update your ",(0,s.mdx)("inlineCode",{parentName:"p"},"ext.config.yaml")," in the ",(0,s.mdx)("inlineCode",{parentName:"p"},"src/dx-asset-compute-worker-1/")," folder to include it."),(0,s.mdx)("pre",null,(0,s.mdx)("code",{parentName:"pre",className:"language-yaml"},"operations:\n  workerProcess:\n    - type: action\n      impl: dx-asset-compute-worker-1/worker\nhooks:\n  post-app-run: adobe-asset-compute devtool\n  test: adobe-asset-compute test-worker\nactions: actions\nruntimeManifest:\n  packages:\n    dx-asset-compute-worker-1:\n      license: Apache-2.0\n      actions:\n        worker:\n          function: actions/worker/index.js\n          web: 'yes'\n          runtime: 'nodejs:14'\n          limits:\n            concurrency: 10\n          inputs:\n              apiKey: $SERVICE_API_KEY\n          annotations:\n            require-adobe-auth: true\n")),(0,s.mdx)("p",null,"Your worker should now be set. "),(0,s.mdx)("p",null,"Run the ",(0,s.mdx)("inlineCode",{parentName:"p"},"aio app deploy")," command to deploy your action to test in the development tool UI."),(0,s.mdx)("p",null,"Then execute the command ",(0,s.mdx)("inlineCode",{parentName:"p"},"aio app run")," to test it. In the development tool UI, select an existing image or upload a new one, define the rendition request, and click the Run button. You will see the rendition result with the background removed."),(0,s.mdx)("p",null,"There are various options of other photo magics that you can use to enhance your custom worker. Consult the ",(0,s.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/firefly-services/docs/photoshop/"},"Photoshop API documentation")," for further details."))}u.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-resources-asset-compute-worker-ps-api-lesson-3-md-542266703bdcf13ef76f.js.map